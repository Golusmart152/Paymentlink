 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="manifest.json">

    <title>FastFin Payment Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css');

        :root {
            --light-bg: #e9ecef;
            --light-card-bg: #ffffff;
            --light-text: #212121;
            --light-border: #dee2e6;
            --light-input-bg: #ffffff;
            --dark-bg: #212529;
            --dark-card-bg: #343a40;
            --dark-text: #f8f9fa;
            --dark-border: #495057;
            --dark-input-bg: #495057;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-bg);
            color: var(--light-text);
            margin: 0;
            padding: 2rem;
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }
        .container { max-width: 700px; width: 100%; margin: auto; }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .main-title { margin: 0; text-align: left; font-size: 1.8rem; }
        .card { background-color: var(--light-card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 2rem; margin-bottom: 1.5rem; transition: background-color 0.3s; }
        body.dark-mode .card { background-color: var(--dark-card-bg); }
        .card-header { margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--light-border); display: flex; justify-content: space-between; align-items: center; transition: border-color 0.3s; }
        body.dark-mode .card-header { border-color: var(--dark-border); }
        .card-header h3 { margin: 0; font-size: 1.25rem; font-weight: 600; color: var(--primary-color); }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; }
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--light-border);
            background-color: var(--light-input-bg);
            color: var(--light-text);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s;
            box-sizing: border-box;
        }
        .client-name-group { display: flex; gap: 0.5rem; }
        .client-name-group .salutation { flex-basis: 100px; flex-grow: 0; }
        .client-name-group .clientName { flex-grow: 1; }
        body.dark-mode input[type="text"], body.dark-mode input[type="number"], body.dark-mode select {
            border-color: var(--dark-border);
            background-color: var(--dark-input-bg);
            color: var(--dark-text);
        }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
        #setupCard .form-grid, #paymentFormCard .form-grid {
             display: grid;
             gap: 1.5rem;
             grid-template-columns: 1fr;
        }
        @media (min-width: 600px) {
            #setupCard .form-grid, #paymentFormCard .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        .button-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-top: 1.5rem; }
        .actions-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
        button, .btn { padding: 0.8rem 1.5rem; font-family: 'Poppins', sans-serif; font-weight: 500; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; text-decoration: none; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 123, 255, 0.25); }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: var(--danger-hover); }
        input[type="file"] { display: none; }
        .branding-area { display: flex; align-items: center; gap: 1rem; background-color: var(--light-input-bg); padding: 1rem; border-radius: 8px; }
        body.dark-mode .branding-area { background-color: var(--dark-input-bg); }
        .status-text { font-style: italic; color: var(--secondary-color); font-weight: 500; }
        #logoPreview { max-width: 150px; max-height: 50px; border-radius: 4px; object-fit: contain; }
        .theme-switcher { display: flex; align-items: center; gap: 0.5rem; }
        .theme-switcher .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .theme-switcher .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 26px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(24px); }
        #historyTable { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        #historyTable th, #historyTable td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--light-border); }
        body.dark-mode #historyTable th, body.dark-mode #historyTable td { border-color: var(--dark-border); }
        #historyTable th { font-weight: 600; }
        #historyTable .actions-cell { text-align: right; }
        #historyTable .actions-cell button + button { margin-left: 0.5rem; }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .message-box { background-color: var(--light-input-bg); border: 1px solid var(--light-border); border-radius: 8px; padding: 1rem; position: relative; }
        body.dark-mode .message-box { background-color: var(--dark-input-bg); border-color: var(--dark-border); }
        #messagePre { white-space: pre-wrap; word-wrap: break-word; font-family: 'Poppins', sans-serif; font-size: 0.95rem; margin: 0; }
        .copy-button { position: absolute; top: 0.8rem; right: 0.8rem; background-color: var(--secondary-color); color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-controls">
            <h1 class="main-title"><i class="fas fa-bolt"></i> FastFin</h1>
            <div class="theme-switcher">
                <i class="fas fa-sun"></i>
                <label class="switch">
                    <input type="checkbox" id="themeToggle">
                    <span class="slider"></span>
                </label>
                <i class="fas fa-moon"></i>
            </div>
        </div>
        <div id="setupCard" class="card">
            <div class="card-header"><h3><i class="fas fa-cogs"></i> One-Time Setup</h3></div>
            <div class="form-grid">
                 <div class="form-group"><label>QR Code Library</label><div id="qrLibContainer" class="branding-area"></div></div>
                <div class="form-group"><label>Company Logo (Optional)</label><div class="branding-area"><img id="logoPreview" src="" alt="Logo Preview" style="display:none;"><span id="logoStatus" class="status-text">No Logo</span><div style="margin-left:auto;"><label for="logoFile" class="btn btn-secondary upload-btn"><i class="fas fa-upload"></i> Upload</label><input type="file" id="logoFile" accept="image/png,image/jpeg"></div></div></div>
                <div class="form-group"><label for="companyName">Company Name (for Business)</label><input type="text" id="companyName" placeholder="e.g., FastFin Solutions"></div>
                <div class="form-group"><label for="personalName">Your Name (for Personal)</label><input type="text" id="personalName" placeholder="e.g., John Doe"></div>
            </div>
             <div class="button-group">
                <button type="button" id="saveSetupButton" class="btn-primary" title="Save Settings"><i class="fas fa-save"></i> Save</button>
                <button type="button" id="backupButton" class="btn-secondary" title="Backup Data"><i class="fas fa-database"></i> Backup</button>
                <button type="button" id="restoreButton" class="btn-secondary" title="Restore Data"><i class="fas fa-undo-alt"></i> Restore</button>
                <input type="file" id="restoreFile" accept=".json">
            </div>
        </div>
        <div id="paymentFormCard" class="card">
            <div class="card-header"><h3><i class="fas fa-file-invoice"></i> Payment Details</h3></div>
            <div class="form-grid">
                 <div class="form-group">
                    <label for="transactionType">Transaction Type</label>
                    <select id="transactionType">
                        <option value="business" selected>Business</option>
                        <option value="personal">Personal</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="clientName">Client's Name</label>
                    <div class="client-name-group">
                        <select id="salutation" class="salutation">
                            <option>Mr.</option>
                            <option>Mrs.</option>
                            <option>Miss</option>
                        </select>
                        <input type="text" id="clientName" class="clientName" placeholder="e.g., Jenny">
                    </div>
                </div>
                <div class="form-group"><label for="item">Item Description</label><input type="text" id="item" value=""></div>
                <div class="form-group"><label for="invoice">Invoice # (Optional)</label><input type="text" id="invoice" value=""></div>
                <div class="form-group"><label for="amount">Amount (INR)</label><input type="number" id="amount" step="0.01" min="1" value=""></div>
                <div class="form-group"><label for="upi">Recipient UPI ID</label><input type="text" id="upi" value=""></div>
            </div>
            <div class="actions-group">
                 <button type="button" id="resetPaymentForm" class="btn-secondary"><i class="fas fa-undo"></i> Reset Form</button>
                <button type="button" class="btn-primary" onclick="generatePaymentHTML()"><i class="fas fa-file-invoice-dollar"></i> Generate Payment</button>
            </div>
        </div>
        <div id="resultsSection" class="card" style="display: none;"></div>
        <div id="historyCard" class="card">
            <div class="card-header"><h3><i class="fas fa-history"></i> Payment History</h3></div>
            <div style="overflow-x:auto;">
                <table id="historyTable">
                    <thead><tr><th>Client</th><th>Amount</th><th>Type</th><th style="text-align:right;">Actions</th></tr></thead>
                    <tbody id="historyTBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        let isQrLibLoaded = false;
        let logoDataUrl = "";
        let currentBlob = null;
        let currentQrCodeDataUrl = null;
        let currentMessage = "";
        let downloadCounter = 1;

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('Service Worker registered successfully.', registration))
                    .catch(err => console.error('Service Worker registration failed.', err));
            });
        }

        // --- Initialization ---
        window.onload = function() {
            const themeToggle = document.getElementById('themeToggle');
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.checked = true;
            }
            handleQrLibrary();
            document.getElementById('companyName').value = localStorage.getItem('companyName') || '';
            document.getElementById('personalName').value = localStorage.getItem('personalName') || '';
            logoDataUrl = localStorage.getItem('companyLogoDataUrl') || "";
            updateLogoStatus();
            downloadCounter = parseInt(localStorage.getItem('downloadCounter') || '1', 10);
            try { renderHistory(); } catch (e) {
                console.error("Failed to render history, clearing corrupted data.", e);
                localStorage.removeItem('paymentHistory');
                renderHistory();
            }
            themeToggle.addEventListener('change', toggleTheme);
            document.getElementById('logoFile').addEventListener('change', uploadLogo);
            document.getElementById('historyTBody').addEventListener('click', handleHistoryClick);
            document.getElementById('saveSetupButton').addEventListener('click', saveSetup);
            document.getElementById('resetPaymentForm').addEventListener('click', resetPaymentForm);
            document.getElementById('backupButton').addEventListener('click', backupData);
            document.getElementById('restoreButton').addEventListener('click', () => document.getElementById('restoreFile').click());
            document.getElementById('restoreFile').addEventListener('change', restoreDataFromFile);
        };
        
        // --- Feature Implementations ---
        function handleQrLibrary() {
            if (typeof QRCode !== 'undefined') {
                isQrLibLoaded = true;
                updateQrUi('success_cdn');
            } else {
                const savedQrScript = localStorage.getItem('qrCodeLibraryScript');
                if (savedQrScript) {
                    injectAndVerifyScript(savedQrScript, 'local');
                } else {
                    updateQrUi('prompt_upload');
                }
            }
        }
        function updateQrUi(status) {
            const container = document.getElementById('qrLibContainer');
            let html = '';
            switch (status) {
                case 'success_cdn':
                    html = `<span class="status-text" style="color:var(--success-color)">Loaded from Internet</span>`;
                    break;
                case 'success_local':
                    html = `<span class="status-text" style="color:var(--success-color)">Loaded from Local Storage</span>`;
                    break;
                case 'success_upload':
                    html = `<span class="status-text" style="color:var(--success-color)">Upload Successful</span>`;
                    break;
                case 'prompt_upload':
                    html = `<span class="status-text">Offline. Please upload QR library.</span>
                            <div style="margin-left:auto;">
                                <label for="qrcodeFile" class="btn btn-secondary upload-btn"><i class="fas fa-upload"></i> Upload</label>
                                <input type="file" id="qrcodeFile" accept=".js">
                            </div>`;
                    break;
                case 'failure':
                    html = `<span class="status-text" style="color:var(--danger-color)">Load failed. Please upload a valid QR library file.</span>
                             <div style="margin-left:auto;">
                                <label for="qrcodeFile" class="btn btn-secondary upload-btn"><i class="fas fa-upload"></i> Upload</label>
                                <input type="file" id="qrcodeFile" accept=".js">
                            </div>`;
                    break;
            }
            container.innerHTML = html;
            if (status === 'prompt_upload' || status === 'failure') {
                document.getElementById('qrcodeFile').addEventListener('change', uploadQrCode);
            }
        }
        function injectAndVerifyScript(scriptContent, source) {
            const script = document.createElement('script');
            const existingScript = document.getElementById('qrCodeLib');
            if (existingScript) existingScript.remove();
            script.id = 'qrCodeLib';
            
            script.onload = () => {
                isQrLibLoaded = typeof QRCode !== 'undefined';
                if(isQrLibLoaded) {
                     updateQrUi(source === 'upload' ? 'success_upload' : 'success_local');
                } else {
                    isQrLibLoaded = false;
                    updateQrUi('failure');
                }
            };
            script.onerror = () => {
                isQrLibLoaded = false;
                updateQrUi('failure');
            };
            
            script.textContent = scriptContent;
            document.head.appendChild(script);
        }
        function uploadQrCode(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const scriptContent = e.target.result;
                localStorage.setItem('qrCodeLibraryScript', scriptContent);
                injectAndVerifyScript(scriptContent, 'upload');
            };
            reader.readAsText(file);
        }
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
        }
        function saveSetup() {
            localStorage.setItem('companyName', document.getElementById('companyName').value);
            localStorage.setItem('personalName', document.getElementById('personalName').value);
            alert('Settings saved!');
        }
        function backupData() {
            const dataToBackup = {
                companyName: localStorage.getItem('companyName') || '',
                personalName: localStorage.getItem('personalName') || '',
                companyLogoDataUrl: localStorage.getItem('companyLogoDataUrl') || '',
                paymentHistory: JSON.parse(localStorage.getItem('paymentHistory') || '[]'),
                downloadCounter: parseInt(localStorage.getItem('downloadCounter') || '1', 10),
                theme: localStorage.getItem('theme') || 'light',
                qrCodeLibraryScript: localStorage.getItem('qrCodeLibraryScript') || ''
            };
            const blob = new Blob([JSON.stringify(dataToBackup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fastfin-backup.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        function restoreDataFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.hasOwnProperty('paymentHistory') || !data.hasOwnProperty('companyName')) {
                        throw new Error('Invalid backup file.');
                    }
                    localStorage.setItem('companyName', data.companyName || '');
                    localStorage.setItem('personalName', data.personalName || '');
                    localStorage.setItem('companyLogoDataUrl', data.companyLogoDataUrl || '');
                    localStorage.setItem('paymentHistory', JSON.stringify(data.paymentHistory || []));
                    localStorage.setItem('downloadCounter', data.downloadCounter || 1);
                    localStorage.setItem('theme', data.theme || 'light');
                    if(data.qrCodeLibraryScript) {
                        localStorage.setItem('qrCodeLibraryScript', data.qrCodeLibraryScript);
                    }
                    alert('Data restored successfully! The page will now reload.');
                    window.location.reload();
                } catch (error) {
                    alert('Failed to restore data. Please make sure you are uploading a valid backup file.');
                    console.error('Restore error:', error);
                }
            };
            reader.readAsText(file);
        }
        function resetPaymentForm() {
            document.getElementById('transactionType').value = 'business';
            document.getElementById('salutation').value = 'Mr.';
            document.getElementById('clientName').value = '';
            document.getElementById('item').value = '';
            document.getElementById('invoice').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('upi').value = '';
            document.getElementById('resultsSection').style.display = 'none';
        }
        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('paymentHistory') || '[]');
            const tbody = document.getElementById('historyTBody');
            tbody.innerHTML = '';
            if(history.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No history yet.</td></tr>`;
                return;
            }
            history.forEach(entry => {
                const fullClientName = `${entry.salutation || ''} ${entry.clientName}`.trim();
                const type = entry.transactionType.charAt(0).toUpperCase() + entry.transactionType.slice(1);
                const row = `
                    <tr>
                        <td>${fullClientName}</td>
                        <td>₹${entry.amount}</td>
                        <td>${type}</td>
                        <td class="actions-cell">
                            <button class="btn btn-secondary btn-small duplicate-btn" data-id="${entry.id}" title="Duplicate"><i class="fas fa-copy"></i></button>
                            <button class="btn btn-danger btn-small delete-btn" data-id="${entry.id}" title="Delete"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>`;
                tbody.insertAdjacentHTML('afterbegin', row);
            });
        }
        function handleHistoryClick(e) {
            const duplicateButton = e.target.closest('.duplicate-btn');
            const deleteButton = e.target.closest('.delete-btn');
            if (duplicateButton) {
                const historyId = duplicateButton.dataset.id;
                const history = JSON.parse(localStorage.getItem('paymentHistory') || '[]');
                const entry = history.find(item => item.id == historyId);
                if (entry) {
                    document.getElementById('transactionType').value = entry.transactionType;
                    document.getElementById('salutation').value = entry.salutation;
                    document.getElementById('clientName').value = entry.clientName;
                    document.getElementById('item').value = entry.item;
                    document.getElementById('invoice').value = entry.invoice;
                    document.getElementById('amount').value = entry.amount;
                    document.getElementById('upi').value = entry.upi;
                    document.getElementById('resultsSection').style.display = 'none';
                    document.getElementById('paymentFormCard').scrollIntoView({ behavior: 'smooth' });
                }
            } else if (deleteButton) {
                const historyId = deleteButton.dataset.id;
                if (confirm('Are you sure you want to delete this history entry?')) {
                    deleteHistoryEntry(historyId);
                }
            }
        }
        function deleteHistoryEntry(id) {
            let history = JSON.parse(localStorage.getItem('paymentHistory') || '[]');
            history = history.filter(item => item.id != id);
            localStorage.setItem('paymentHistory', JSON.stringify(history));
            renderHistory();
        }
        async function generatePaymentHTML() {
            if (!validateInputs()) return;
            const transactionType = document.getElementById('transactionType').value;
            let displayName, finalLogoUrl;
            if (transactionType === 'personal') {
                displayName = document.getElementById('personalName').value;
                finalLogoUrl = '';
            } else {
                displayName = document.getElementById('companyName').value;
                finalLogoUrl = logoDataUrl;
            }
            const data = {
                transactionType: transactionType,
                salutation: document.getElementById('salutation').value,
                clientName: document.getElementById('clientName').value,
                item: document.getElementById('item').value,
                invoice: document.getElementById('invoice').value,
                amount: document.getElementById('amount').value,
                upi: document.getElementById('upi').value,
                displayName: displayName,
                id: Date.now()
            };
            const fullClientName = `${data.salutation} ${data.clientName}`.trim();
            const tn = data.invoice ? `Payment for ${data.item}, Invoice #${data.invoice}` : `Payment for ${data.item}`;
            const upiLink = `upi://pay?pa=${encodeURIComponent(data.upi)}&pn=${encodeURIComponent(data.displayName)}&am=${data.amount}&cu=INR&tn=${encodeURIComponent(tn)}`;
            try {
                currentQrCodeDataUrl = await generateQrCodeDataUrl(upiLink, 200);
                currentBlob = new Blob([getModernPaymentHTML(data, upiLink, currentQrCodeDataUrl, finalLogoUrl)], { type: 'text/html' });
                const messageNote = data.invoice ? `for Invoice #${data.invoice}` : `for ${data.item}`;
                currentMessage = `Hi ${fullClientName},\n\nYour payment of ₹${data.amount} ${messageNote} is due. Please open the attached payment file to pay.\n\nThank you,\n${data.displayName}`;
                populateResultsSection(currentMessage);
                const history = JSON.parse(localStorage.getItem('paymentHistory') || '[]');
                history.push(data);
                localStorage.setItem('paymentHistory', JSON.stringify(history));
                renderHistory();
            } catch (error) {
                console.error("Generation Error:", error);
                alert("An error occurred during generation. Please check the console for details.");
            }
        }
        function uploadLogo(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = e => { 
                logoDataUrl = e.target.result; 
                localStorage.setItem('companyLogoDataUrl', logoDataUrl); 
                updateLogoStatus(); 
            };
            reader.readAsDataURL(file);
        }
        function updateLogoStatus() {
            const preview = document.getElementById('logoPreview');
            const status = document.getElementById('logoStatus');
            if (logoDataUrl) { preview.src = logoDataUrl; preview.style.display = 'block'; status.style.display = 'none'; } 
            else { preview.style.display = 'none'; status.style.display = 'block'; }
        }
        function validateInputs() {
            if (!isQrLibLoaded) {
                alert('QR Code library is not loaded. Please connect to the internet or upload the required file.');
                return false;
            }
            const transactionType = document.getElementById('transactionType').value;
            const clientName = document.getElementById('clientName').value;
            const amount = document.getElementById('amount').value;
            const requiredFields = { clientName: "Client's Name", item: "Item Description", amount: "Amount", upi: "Recipient UPI ID" };
            if (transactionType === 'business') {
                requiredFields['companyName'] = "Company Name";
            } else {
                requiredFields['personalName'] = "Your Name";
            }
            for (const id in requiredFields) {
                if (!document.getElementById(id).value) {
                    alert(`Please fill in the "${requiredFields[id]}" field.`);
                    return false;
                }
            }
            if (!/^[a-zA-Z\s.]+$/.test(clientName)) {
                alert('Client Name can only contain letters, spaces, and periods.');
                return false;
            }
            if (isNaN(parseFloat(amount)) || !isFinite(amount) || parseFloat(amount) < 1) {
                alert('Amount must be a number greater than or equal to 1.');
                return false;
            }
            return true;
        }
        function populateResultsSection(message) {
            const resultsContainer = document.getElementById('resultsSection');
            resultsContainer.innerHTML = `
                <div class="card-header"><h3><i class="fas fa-share-alt"></i> Share with Client</h3></div>
                <div class="message-box">
                    <strong>Message to Client:</strong>
                    <pre id="messagePre">${message}</pre>
                    <button class="copy-button" onclick="copyToClipboard('#messagePre')"><i class="fas fa-copy"></i> Copy</button>
                </div>
                <div class="actions-group">
                    <button class="btn-primary" onclick="sharePayment()"><i class="fab fa-whatsapp"></i> Share Payment File</button>
                    <button class="btn-secondary" onclick="downloadPayment()"><i class="fas fa-download"></i> Download HTML</button>
                    <button class="btn-primary" onclick="shareQrCode()"><i class="fab fa-whatsapp"></i> Share QR Image</button>
                    <button class="btn-secondary" onclick="downloadQrCode()"><i class="fas fa-download"></i> Download QR Image</button>
                </div>`;
            resultsContainer.style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }
        async function dataUrlToFile(dataUrl, fileName, fileType) {
            const res = await fetch(dataUrl);
            const blob = await res.blob();
            return new File([blob], fileName, { type: fileType });
        }
        async function sharePayment() { 
            if (navigator.share) {
                try {
                    const file = new File([currentBlob], 'payment.html', { type: 'text/html' });
                    await navigator.share({ files: [file], text: currentMessage });
                } catch(e){ if (e.name !== 'AbortError') console.error(e) }
            } else {
                alert('Direct sharing not supported on this browser/device.');
            }
        }
        async function shareQrCode() { 
            if (navigator.share && currentQrCodeDataUrl) {
                try {
                    const file = await dataUrlToFile(currentQrCodeDataUrl, 'payment_qr.png', 'image/png');
                    await navigator.share({ files: [file] });
                } catch(e){ if (e.name !== 'AbortError') console.error(e) }
            } else {
                alert('Direct sharing not supported on this browser/device.');
            }
        }
        function downloadPayment() { 
            const url = URL.createObjectURL(currentBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `payment(${downloadCounter}).html`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
            downloadCounter++;
            localStorage.setItem('downloadCounter', downloadCounter);
        }
        function downloadQrCode() { 
            const a = document.createElement('a');
            a.href = currentQrCodeDataUrl;
            a.download = `payment_qr(${downloadCounter}).png`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            downloadCounter++;
            localStorage.setItem('downloadCounter', downloadCounter);
        }
        function copyToClipboard(elementSelector) {
            const textToCopy = document.querySelector(elementSelector).innerText;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy).then(() => alert('Message copied!')).catch(() => fallbackCopyTextToClipboard(textToCopy));
            } else {
                fallbackCopyTextToClipboard(textToCopy);
            }
        }
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                if (document.execCommand('copy')) alert('Message copied!'); else alert('Copy failed.');
            } catch (err) { alert('Copy failed.'); }
            document.body.removeChild(textArea);
        }
        function generateQrCodeDataUrl(text, size) {
            return new Promise((resolve, reject) => {
                if (!isQrLibLoaded) return reject(new Error('QRCode library not loaded.'));
                const tempDiv = document.createElement('div');
                try {
                    new QRCode(tempDiv, { text: text, width: size, height: size, correctLevel: QRCode.CorrectLevel.H });
                    setTimeout(() => {
                        const canvas = tempDiv.querySelector('canvas');
                        if (canvas) {
                            resolve(canvas.toDataURL('image/png'));
                        } else {
                           reject(new Error('QR canvas could not be generated. Check QR library.'));
                        }
                    }, 50);
                } catch (e) {
                    reject(e);
                }
            });
        }
        function getModernPaymentHTML(data, upiLink, qrCodeUrl, finalLogoUrl) {
            const logoBlock = finalLogoUrl ? `<img src="${finalLogoUrl}" alt="${data.displayName} Logo" class="company-logo"><h2 class="company-name">${data.displayName}</h2>` : `<h2 class="company-name">${data.displayName}</h2>`;
            const invoiceBlock = data.invoice ? `<p class="invoice-details">Invoice #${data.invoice}</p>` : '';
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment to ${data.displayName}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css');
        body { font-family: 'Poppins', sans-serif; background-color: #f4f7f6; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .payment-card { background-color: #ffffff; border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); max-width: 400px; width: 100%; text-align: center; padding: 40px 30px; overflow: hidden; position: relative; }
        .paying-to-title { font-size: 0.9rem; color: #666; margin-bottom: 20px; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }
        .company-logo { max-width: 150px; max-height: 70px; object-fit: contain; }
        .company-name { font-size: 1.2rem; font-weight: 700; color: #0056b3; margin-top: 10px; margin-bottom: 25px; }
        .payment-title { font-size: 1.5rem; font-weight: 600; margin: 0 0 10px; }
        .invoice-details { font-size: 1rem; color: #666; margin-bottom: 20px; }
        .thank-you-note { font-size: 0.95rem; color: #555; margin: 0 20px 20px; line-height: 1.5; }
        .amount-display { font-size: 2.8rem; font-weight: 700; color: #007bff; margin: 20px 0; }
        .pay-button { display: inline-block; width: 100%; padding: 12px; background: linear-gradient(45deg, #007bff, #0056b3); color: white; text-decoration: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; transition: all 0.3s ease; box-sizing: border-box; }
        .scan-prompt { margin-top: 20px; font-size: 1rem; color: #666; font-weight: 500; }
        .qr-code { margin: 15px auto; border: 5px solid #eee; border-radius: 12px; padding: 10px; display: inline-block; }
        .qr-code img { max-width: 180px; display: block; }
    </style>
</head>
<body>
    <div class="payment-card">
        <p class="paying-to-title">You are paying to</p>
        ${logoBlock}
        <h1 class="payment-title">Payment for ${data.item}</h1>
        ${invoiceBlock}
        <p class="thank-you-note">Thank you for your business. We appreciate your prompt payment.</p>
        <div class="amount-display">₹${parseFloat(data.amount).toFixed(2)}</div>
        <a href="${upiLink}" class="pay-button"><i class="fas fa-shield-alt"></i> Click to Pay</a>
        <p class="scan-prompt"><b>Or scan below QR code</b></p>
        <div class="qr-code"><img src="${qrCodeUrl}" alt="Scan to Pay"></div>
    </div>
</body>
</html>`;
        }
    </script>
</body>
</html>
